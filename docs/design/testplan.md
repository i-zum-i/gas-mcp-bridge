# テスト計画書

## 概要
GAS MCP Bridgeプロジェクトの包括的なテスト戦略と実行計画を定義する。本ドキュメントは要件定義書、詳細設計書、タスク一覧に基づき、品質保証の完全なフレームワークを提供する。

## プロジェクト概要

- **対象システム**: Google Apps Script (GAS) を MCP (Model Context Protocol) サーバとして公開するNode.jsブリッジ  
- **主要機能**: YAML注釈によるツール定義、clasp連携、MCP stdio/TCP通信、認証、エラーハンドリング  
- **品質目標**: 高可用性、セキュリティ、使いやすさ、拡張性

## テスト戦略

### テストレベル
1. **単体テスト (Unit Tests)** - 各モジュールの独立機能検証
2. **統合テスト (Integration Tests)** - モジュール間連携・設定ファイル・環境変数
3. **E2Eテスト (End-to-End Tests)** - 完全ワークフローの端-to-端検証  
4. **手動テスト (Manual Tests)** - 実際のGAS環境での動作確認
5. **セキュリティテスト (Security Tests)** - 認証・認可・情報漏洩防止
6. **パフォーマンステスト (Performance Tests)** - 応答時間・スループット・リソース消費
7. **互換性テスト (Compatibility Tests)** - 異なる環境・バージョンでの動作確認

### テスト環境
- **ローカルテスト環境**: Jest + TypeScript + モックサーバ
- **モックGAS環境**: Express.jsベースのHTTPサーバ
- **隔離環境**: 一時ディレクトリによるファイルシステム分離
- **実GAS環境**: Google Apps Script WebApp (手動テスト用)
- **CI環境**: GitHub Actions (予定)
- **複数Node.jsバージョン**: 18.x, 20.x, 22.x (互換性確認)

### テスト観点マトリクス
| 観点 | 単体 | 統合 | E2E | 手動 | セキュリティ | パフォーマンス |
|------|------|------|-----|------|--------------|----------------|
| **機能正確性** | ✅ | ✅ | ✅ | ✅ | - | - |
| **エラーハンドリング** | ✅ | ✅ | ✅ | ✅ | ✅ | - |
| **パフォーマンス** | - | - | ✅ | ✅ | - | ✅ |
| **セキュリティ** | ✅ | ✅ | ✅ | ✅ | ✅ | - |
| **使いやすさ** | - | - | ✅ | ✅ | - | - |
| **拡張性** | ✅ | ✅ | ✅ | ✅ | - | - |

## 実装済みテストケース

### 1. 単体テスト

#### 1.1 generate モジュール (`tests/unit/generate.test.ts`)
**目的**: YAML注釈解析とツール定義生成の検証

- **findTools()機能**
  - ✅ 有効な@mcp注釈の検出
  - ✅ 1ファイル内の複数ツール処理
  - ✅ 無効YAML形式の無視
  - ✅ 注釈なしファイルの処理

- **processTools()機能**
  - ✅ 有効ツール定義の検証・処理
  - ✅ 必須項目（name）不足時のスキップ
  - ✅ スキーマ無効時のスキップ  
  - ✅ path省略時のデフォルト値設定
  - ✅ 重複ツール名の処理（後勝ち）

- **generate()統合機能**
  - ✅ デフォルトモード: echo自動生成
  - ✅ 厳格モード (MCP_STRICT=1): エラー終了
  - ✅ 空モード (MCP_MODE=empty): 空配列出力
  - ✅ 注釈発見時の実ツール生成

#### 1.2 discover モジュール (`tests/unit/discover.test.ts`)
**目的**: clasp連携とGAS設定自動検出の検証

- **getScriptId()機能**
  - ✅ 有効な.clasp.json読み込み
  - ✅ ファイル不存在時のエラー
  - ✅ scriptId不足時のエラー
  - ✅ 空scriptId時のエラー
  - ✅ 無効JSON時のエラーハンドリング

- **getClaspCredentials()機能**
  - ✅ ~/.clasprc.json認証情報読み込み
  - ✅ ファイル不存在時のエラー
  - ✅ access_token不足時のエラー

- **getWebAppDeployment()機能**
  - ✅ WebAppデプロイメント検出
  - ✅ デプロイメント不存在時のnull返却
  - ✅ デプロイメント空配列時の処理
  - ✅ API エラーハンドリング

- **saveMcpConfig()機能**
  - ✅ MCP設定の.mcp-gas.json保存
  - ✅ オプション項目の正しい処理
  - ✅ JSON整形出力

#### 1.3 gas-client モジュール (`tests/unit/gas-client.test.ts`)
**目的**: GAS HTTP通信とエラーハンドリングの検証

- **GASClientコンストラクタ**
  - ✅ デフォルトオプションでの生成
  - ✅ 環境変数（MCP_TIMEOUT_MS/MCP_RETRY）の使用
  - ✅ 明示的オプションの優先適用

- **callTool()機能**
  - ✅ 正常なツール呼び出し
  - ✅ トークン認証ヘッダの送信
  - ✅ 認証失敗の処理
  - ✅ GASレベルエラー処理
  - ✅ HTTPエラーハンドリング
  - ✅ タイムアウト処理
  - ✅ リトライ機能（失敗時）
  - ✅ 環境変数設定の反映

- **エラー型**
  - ✅ GASClientErrorの生成（ステータスコード付き）
  - ✅ GASClientErrorの生成（GASレスポンス付き）

- **ファクトリ関数**
  - ✅ createGASClient()による生成
  - ✅ レガシーcallGAS()関数の動作

- **モックサーバ連携**
  - ✅ デフォルトecho応答
  - ✅ 複数リクエスト追跡
  - ✅ モックサーバ状態リセット

#### 1.4 server モジュール (`tests/unit/server.test.ts`)
**目的**: MCPサーバ統合とツール実行の検証

- **ツール読み込み**
  - ✅ mcp.tools.json存在時のツール読み込み
  - ✅ ファイル不存在時のechoツール生成
  - ✅ .mcp-gas.json設定読み込み統合

- **echoツール動作**
  - ✅ テンプレートメッセージ返却
  - ✅ 入力データのecho
  - ✅ 注釈作成ガイダンス提供

- **GASツール統合**
  - ✅ モックGASサーバとの通信
  - ✅ リクエスト/レスポンス検証
  - ✅ GASクライアントエラー処理
  - ✅ 設定ファイル不存在エラー

- **環境変数処理**
  - ✅ GAS_API_TOKEN環境変数使用

### 2. E2Eテスト

#### 2.1 ローカル統合テスト (`tests/e2e/local.test.ts`)
**目的**: 完全ワークフローの端-to-端検証

- **完全ワークフロー**
  - ✅ 注釈作成 → generate → GAS通信 → 結果検証
  - ✅ 複数ツール処理（sheet.appendRow + drive.listFiles）
  - ✅ 複雑スキーマのツール処理
  - ✅ モックGASサーバとの完全疎通

- **エラーシナリオ**
  - ✅ GAS実行エラーの端-to-端処理
  - ✅ 認証失敗の統合処理
  - ✅ 注釈なし時のechoツール動作

- **環境変数統合**
  - ✅ MCP_STRICT=1モードの端-to-端動作
  - ✅ MCP_MODE=emptyモードの端-to-端動作
  - ✅ GAS_API_TOKEN環境変数の統合

- **設定ファイル統合**
  - ✅ MCP設定保存・読み込みの完全サイクル
  - ✅ 設定ファイルとクライアント生成の統合

- **複雑ツール処理**
  - ✅ ネストオブジェクト・配列・制約付きスキーマ
  - ✅ 複雑入力データの完全サイクル処理

### 3. モックサーバ (`mocks/mock-gas-server.ts`)
**目的**: GAS WebApp APIの完全模倣

- **基本機能**
  - ✅ POST /exec エンドポイント
  - ✅ {ok, result/message} レスポンス形式
  - ✅ Authorization: Bearer 認証
  - ✅ デフォルトecho動作

- **テスト支援機能**
  - ✅ モックレスポンス設定
  - ✅ 認証トークン設定・無効化
  - ✅ リクエスト履歴追跡
  - ✅ 状態リセット機能

## テスト実行環境

### 技術基盤
- **テストランナー**: Jest 30.0.5
- **TypeScript**: ts-jest ES Module対応
- **モック**: Express.js + HTTPサーバ
- **隔離**: 一時ディレクトリ + process.chdir()

### 実行コマンド
```bash
npm test              # 全テスト実行
npm run test:watch    # ウォッチモード
npm run test:coverage # カバレッジ測定
```

### カバレッジ対象
- `src/**/*.ts` (全ソースファイル)
- 除外: `src/**/*.d.ts`, `src/index.ts`

## テスト結果期待値

### 成功パターン
- 全テストケース通過
- TypeScriptコンパイルエラーなし
- モックサーバ完全分離実行
- 一時ディレクトリによる副作用なし

### カバレッジ目標
- **行カバレッジ**: 90%以上
- **関数カバレッジ**: 95%以上
- **分岐カバレッジ**: 85%以上

## 要件トレーサビリティマトリクス

### 要件定義書との対応
| 要件ID | 要件内容 | 対応テストケース | 実装状況 |
|--------|----------|------------------|----------|
| **R-3.3** | YAML注釈によるツール定義 | generate.test.ts: findTools/processTools | ✅ |
| **R-3.4** | 3モード（デフォルト/STRICT/empty） | generate.test.ts: generate modes | ✅ |
| **R-3.5** | Bearer認証セキュリティ | gas-client.test.ts: 認証テスト | ✅ |
| **R-4** | clasp統合フロー | discover.test.ts: 全機能 | ✅ |
| **R-運用** | npm導入・build・start | E2E local.test.ts | ✅ |

### 詳細設計書（design.md）との対応  
| 設計ID | 設計内容 | 対応テストケース | 実装状況 |
|--------|----------|------------------|----------|
| **D-2** | MCP stdio/TCP通信 | server.test.ts: MCPサーバ統合 | 🔶 (stdioのみ) |
| **D-3.3** | callGAS HTTP実装 | gas-client.test.ts: HTTP通信 | ✅ |
| **D-4.1** | 環境変数(MCP_*) | 全テスト: 環境変数統合 | ✅ |
| **D-11** | テスト計画 | 本テスト計画書 | ✅ |

### タスク一覧（tasks.md）との対応
| タスクID | タスク内容 | 対応テストケース | 実装状況 |
|----------|------------|------------------|----------|
| **6-1** | モックGAS | mock-gas-server.ts | ✅ |
| **6-2** | Unit: generate | generate.test.ts | ✅ |
| **6-3** | Unit: discover | discover.test.ts | ✅ |  
| **6-4** | Unit: gas-client | gas-client.test.ts | ✅ |
| **6-5** | Unit: server | server.test.ts | ✅ |
| **6-6** | E2E: ローカル | local.test.ts | ✅ |
| **7-1** | 実GAS検証例 | examples/ | ⬜ |
| **7-2** | 手動E2E手順 | tests/e2e/*.md | ⬜ |

## 未実装テスト要件

### 1. セキュリティテスト（新規追加が必要）
**目的**: 認証・認可・情報漏洩防止の検証

- **認証セキュリティ**
  - ⬜ 不正トークンでの アクセス拒否
  - ⬜ トークン無しでの アクセス拒否  
  - ⬜ 期限切れトークンの処理
  - ⬜ Authorization ヘッダの暗号化検証

- **情報漏洩防止**
  - ⬜ ログにトークン情報非表示  
  - ⬜ エラーメッセージに機密情報非含有
  - ⬜ 設定ファイルのパーミッション確認

### 2. パフォーマンステスト（新規追加が必要）
**目的**: 応答時間・スループット・リソース消費の検証

- **応答性能**
  - ⬜ ツール実行時間 < 30秒（デフォルトタイムアウト）
  - ⬜ build処理時間 < 10秒（100ファイル想定）
  - ⬜ start起動時間 < 5秒

- **リソース消費**  
  - ⬜ メモリ使用量 < 100MB（通常使用時）
  - ⬜ ファイルディスクリプタリーク無し
  - ⬜ 長時間実行でのメモリリーク無し

### 3. 互換性テスト（新規追加が必要）
**目的**: 異なる環境・バージョンでの動作確認

- **Node.jsバージョン**
  - ⬜ Node.js 18.x での動作確認
  - ⬜ Node.js 20.x での動作確認  
  - ⬜ Node.js 22.x での動作確認

- **OS環境**
  - ⬜ Windows での動作確認
  - ⬜ macOS での動作確認
  - ⬜ Linux（Ubuntu/CentOS）での動作確認

### 4. TCP通信モードテスト（新規追加が必要）
**目的**: MCP_TRANSPORT=tcp設定での動作確認

- **TCP サーバ**
  - ⬜ TCP_PORT環境変数での起動
  - ⬜ TCP接続での tool呼び出し
  - ⬜ TCP切断処理

### 5. CI/CD統合テスト（新規追加が必要）  
**目的**: 継続的インテグレーションでの品質保証

- **GitHub Actions**
  - ⬜ PR時の自動テスト実行
  - ⬜ 複数Node.jsバージョン並列テスト
  - ⬜ カバレッジレポート自動生成
  - ⬜ テスト失敗時のPRブロック

### 6. 実GAS手動テスト（7系タスク対応）
**目的**: 実際のGoogle Apps Script環境での動作確認

- **実GAS例サンプル**
  - ⬜ examples/simple-gas-project/ 作成
  - ⬜ appsscript.json, Code.gs サンプル
  - ⬜ 注釈付きツール実装例

- **手動E2E手順書**  
  - ⬜ tests/e2e/e2e.gas.test.md 作成
  - ⬜ clasp login → create → deploy → build → start の完全手順
  - ⬜ 実MCPクライアント(Claude/VSCode)からの呼び出し手順

## 制限事項・注意事項

### 現在実装済みの範囲
- ローカルモック環境での完全テスト
- 単体・統合・E2Eの3レベルカバー
- エラーケース・環境変数・設定ファイル統合
- 要件定義書の主要機能網羅

### テスト環境の制約
- Google APIs の完全モック（実API呼び出し無し）
- MCP SDKのモック化（実MCP通信無し）
- 実GAS WebApp環境でのテスト未実装

### 今後の優先課題
1. **セキュリティテスト** - セキュリティ要件の完全検証
2. **実GAS手動テスト** - 利用者体験の実証  
3. **CI統合** - 開発プロセスの自動化
4. **パフォーマンステスト** - 本番運用での性能保証